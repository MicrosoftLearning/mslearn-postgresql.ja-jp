---
lab:
  title: Azure Database for PostgreSQL でアクセス許可を構成する
  module: Secure Azure Database for PostgreSQL
---

# Azure Database for PostgreSQL でアクセス許可を構成する

このラボの演習では、RBAC ロールを割り当てて Azure Database for PostgreSQL リソースへのアクセスを制御し、PostgreSQL GRANTS を割り当ててデータベース操作へのアクセスを制御します。

## 開始する前に

この演習を完了するには、自分の Azure サブスクリプションが必要です。 Azure サブスクリプションを持っていない場合は、[Azure の無料試用版](https://azure.microsoft.com/free)を作成してください。

これらの演習を完了するには、Microsoft Entra ID (旧称 Azure Active Directory) に接続されている PostgreSQL サーバーをインストールする必要があります。

### リソース グループを作成します

1. Web ブラウザーで、[Azure portal](https://portal.azure.com) に移動します。 所有者または共同作成者のアカウントを使用してサインインします。
2. [Azure サービス] で、**[リソース グループ]**、**[+ 作成]** の順に選択します。
3. 正しいサブスクリプションが表示されていることを確認し、[リソース グループ名]に「**rg-PostgreSQL_Entra**」と入力します。 **リージョン**を選択します。
4. **[確認と作成]** を選択します。 **[作成]** を選択します。

## Azure Database for PostgreSQL フレキシブル サーバーを作成する

1. [Azure サービス] で、**[+ リソースの作成]** を選択します。
    1. **[Marketplace を検索]** で「**`azure database for postgresql flexible server`**」と入力し、**[Azure Database for PostgreSQL フレキシブル サーバー]** を選択して、**[作成]** をクリックします。
1. フレキシブル サーバーの **[基本]** タブで、各フィールドに次のように入力します。
    1. [サブスクリプション] - お使いのサブスクリプション。
    1. [リソース グループ] - **rg-PostgreSQL_Entra**。
    1. [サーバー名] - **psql-postgresql-fx7777** (サーバー名はグローバルに一意である必要があるため、7777 を 4 つのランダムな数字に置換してください)。
    1. [リージョン] - リソース グループと同じリージョンを選択します。
    1. [PostgreSQL バージョン] - [16] を選択します。
    1. [ワークロードの種類] - **開発**。
    1. [コンピューティングとストレージ] - **バースト可能、B1ms**。
    1. [可用性ゾーン] - 優先設定なし。
    1. [高可用性] - オフのままにします。
    1. 認証方法 - **[PostgreSQL と Microsoft Entra 認証]** を選択します。
    1. Microsoft Entra 管理者を設定する - **[管理者の設定]** を選択します。
        1. **[Microsoft Entra 管理者の選択]** でアカウントを検索し、(o) アカウントを選択して **[選択]** をクリックします。
    1. **[管理者ユーザー名]** に「**`demo`**」と入力します。
    1. **[パスワード]** に適度に複雑なパスワードを入力します。
    1. **[次: ネットワーク >]** を選択します。
1. フレキシブル サーバーの **[ネットワーク]** タブで、各フィールドに次のように入力します。
    1. [接続方法]: (o) パブリック アクセス (許可された IP アドレス) とプライベート エンドポイント
    1. [パブリック アクセス] で、**[パブリック IP アドレスを使用したインターネット経由のこのリソースへのパブリック アクセスを許可する]** を選択します。
    1. [ファイアウォール規則] で、**[+ 現在のクライアント IP アドレスを追加する]** を選択して、現在の IP アドレスをファイアウォール規則として追加します。 必要に応じて、このファイアウォール規則に意味のある名前を付けることができます。 また、**[0.0.0.0 - 255.255.255.255 の追加]** を選択し、**[続行]** を選択します。
1. **[確認と作成]** を選択します。 設定を確認したあと、**[作成]** を選択して、Azure Database for PostgreSQL フレキシブル サーバーを作成します。 デプロイが完了したら、次の手順 **[リソースに移動]** を選択して次の手順の準備を行います。

## Azure Data Studio をインストールする

Azure Database for PostgreSQL で使うために Azure Data Studio をインストールするには:

1. ブラウザーで「[Azure Data Studio のダウンロードとインストール](/sql/azure-data-studio/download-azure-data-studio)」に移動し、Windows プラットフォームで「**ユーザー インストーラー (推奨)**」を選びます。 実行可能ファイルがダウンロード フォルダーにダウンロードされます。
1. **[ファイルを開く]** を選びます。
1. 使用許諾契約書が表示されます。 **契約書を読んで同意**してから、**[次へ]** を選びます。
1. **[追加タスクの選択]** で、**[PATH に追加]** と、その他の必要な追加を選びます。 [**次へ**] を選択します。
1. **[インストールの準備完了]** ダイアログ ボックスが表示されます。 設定を確認します。 **[戻る]** を選んで変更を行うか、**[インストール]** を選びます。
1. **[Completing the Azure Data Studio Setup Wizard](Azure Data Studio セットアップ ウィザードの完了)** ダイアログ ボックスが表示されます。 **[完了]** を選びます。 Azure Data Studio が開始します。

### PostgreSQL 拡張機能をインストールする

1. Azure Data Studio がまだ開いていない場合は、開きます。
1. 左側のメニューで **[拡張機能]** を選んで、[拡張機能] パネルを表示します。
1. 検索バーに「**PostgreSQL**」と入力します。 Azure Data Studio 用 PostgreSQL 拡張機能のアイコンが表示されます。
1. **[インストール]** を選択します。 拡張機能がインストールされます。

### Azure Database for PostgreSQL フレキシブル サーバーに接続する

1. Azure Data Studio がまだ開いていない場合は、開きます。
1. 左側のメニューから **[接続]** を選びます。
1. **[新しい接続]** を選びます。
1. **[接続の詳細]** の **[接続の種類]** で、ドロップダウン リストから **[PostgreSQL]** を選びます。
1. **[サーバー名]** に、Azure portal に表示される完全なサーバー名を入力します。
1. **[認証の種類]** は [パスワード] のままにします。
1. [ユーザー名] と [パスワード] に、ユーザー名 **demo** と上で作成した複雑なパスワードを入力します。
1. [パスワードを記憶する] を選びます。
1. 残りのフィールドは省略可能です。
1. **[接続]** を選択します。 Azure Database for PostgreSQL サーバーに接続されます。
1. サーバー データベースの一覧が表示されます。 これには、システム データベースとユーザー データベースが含まれます。

### zoo データベースを作成する

1. 演習スクリプト ファイルがあるフォルダーに移動するか、[MSLearn PostgreSQL Labs](https://github.com/MicrosoftLearning/mslearn-postgresql/blob/main/Allfiles/Labs/02) から **Lab2_ZooDb.sql** をダウンロードします。
1. Azure Data Studio がまだ開いていない場合は、開きます。
1. **[ファイル]**、**[ファイルを開く]** の順に選び、スクリプトを保存したフォルダーに移動します。 **../Allfiles/Labs/02/Lab2_ZooDb.sql** を選択して、**[開く]** を選択します。 信頼の警告が表示される場合は、**[開く]** を選びます。
1. スクリプトを実行します。 zoodb データベースが作成されます。

## Microsoft Entra ID で新しいユーザー アカウントを作成する

> [!NOTE]
> ほとんどの運用環境または開発環境では、Microsoft Entra ID サービスでアカウントを作成するためのサブスクリプション アカウント特権がない可能性が高いです。  その場合は、組織で許可されていれば、Microsoft Entra ID 管理者にテスト アカウントの作成を依頼してください。 テスト Entra アカウントを取得できない場合は、このセクションをスキップして、「**Azure Database for PostgreSQL へのアクセス権を付与する**」セクションに進んでください。 

1. [Azure portal](https://portal.azure.com) で、所有者アカウントを使用してサインインし、Microsoft Entra ID に移動します。
1. **[管理]** にある **[ユーザー]** を選択します。
1. 左上の **[新しいユーザー]** を選択し、**[新規ユーザーの作成]** を選択します。
1. **[新しいユーザー]** ページで、次の詳細を入力し、**[作成]** を選択します。
    - **[ユーザー プリンシパル名]:** プリンシパル名を選択します
    - **[表示名]:** 表示名を選択します
    - **[パスワード]:** **[パスワードの自動生成]** をオフにし、強力なパスワードを入力します。 このプリンシパル名とパスワードをメモします。
    - **[確認と作成]** をクリックします。

    > [!TIP]
    > ユーザーが作成されたら、後でログインに使用できるように、**ユーザー プリンシパル名**を書き留めておきます。

### 閲覧者ロールを割り当てる

1. Azure portal で、**[すべてのリソース]** を選択し、対象の Azure Database for PostgreSQL リソースを選択します。
1. **[アクセス制御 (IAM)]** を選択し、**[ロールの割り当て]** を選択します。 新しいアカウントが一覧に表示されません。
1. **[+ 追加]** を選択し、**[ロールの割り当ての追加]** を選択します。
1. **[閲覧者]** ロールを選択し、**[次へ]** を選択します。
1. **[+ メンバーの選択]** を選択し、前の手順で追加した新しいアカウントをメンバーの一覧に追加して、**[次へ]** を選択します。
1. **[レビューと割り当て]** を選択します。

### 閲覧者ロールをテストする

1. Azure portal の右上の自分のユーザー アカウントを選択し、**[サインアウト]** を選択します。
1. 書き留めておいたユーザー プリンシパル名とパスワードを使用して、新しいユーザーとしてサインインします。 メッセージが表示されたら、既定のパスワードを置き換え、新しいパスワードを書き留めます。
1. 多要素認証を求められた場合は、**[後で確認します]** を選択します。
1. ポータルのホーム ページで、**[すべてのリソース]** を選択し、対象の Azure Database for PostgreSQL リソースを選択します。
1. **[停止]** を選択します。 閲覧者ロールではリソースを表示できますが、変更できないため、エラーが表示されます。

### 共同作成者ロールを割り当てる

1. Azure portal の右上で、新しいアカウントのユーザー アカウントを選択し、**[サインアウト]** を選択します。
1. 元の所有者アカウントを使用してサインインします。
1. 対象の Azure Database for PostgreSQL リソースに移動し、**[アクセス制御 (IAM)]** を選択します。
1. **[+ 追加]** を選択し、**[ロールの割り当ての追加]** を選択します。
1. **[特権管理者ロール]** を選択します。
1. **[共同作成者] **ロールを選択し、**[次へ]** を選択します。
1. 以前に追加した新しいアカウントをメンバーの一覧に追加し、**[次へ]** を選択します。
1. **[レビューと割り当て]** を選択します。
1. **[ロールの割り当て]** を選択します。 これで、新しいアカウントに閲覧者ロールと共同作成者ロールの両方が割り当てられました。

## 共同作成者ロールをテストする

1. Azure portal の右上の自分のユーザー アカウントを選択し、**[サインアウト]** を選択します。
1. 書き留めておいたユーザー プリンシパル名とパスワードを使用して、新しいアカウントとしてサインインします。
1. ポータルのホーム ページで、**[すべてのリソース]** を選択し、対象の Azure Database for MySQL リソースを選択します。
1. **[停止]** を選択し、**[はい]** を選択します。 今回は、新しいアカウントに必要なロールが割り当てられているため、エラーが発生せずにサーバーが停止します。
1. **[開始]** を選択して、PostgreSQL サーバーで次の手順に進むための準備ができていることを確認します。
1. Azure portal の右上で、新しいアカウントのユーザー アカウントを選択し、**[サインアウト]** を選択します。
1. 元の所有者アカウントを使用してサインインします。

## Azure Database for PostgreSQL にアクセス権を付与する

1. Azure Data Studio を開き、上記で管理者として設定した**デモ** ユーザーを使用して Azure Database for PostgreSQL サーバーに接続します。
1. クエリ ウィンドウで、postgres データベースに対してこのコードを実行します。 接続に使用している**デモ** ロールを含め、12 個のユーザー ロールが返されます。

    ```SQL
    SELECT rolname FROM pg_catalog.pg_roles;
    ```

1. 新しいロールを作成するには、次のコードを実行します

    ```SQL
    CREATE ROLE dbuser WITH LOGIN NOSUPERUSER INHERIT CREATEDB NOCREATEROLE NOREPLICATION PASSWORD 'R3placeWithAComplexPW!';
    GRANT CONNECT ON DATABASE zoodb TO dbuser;
    ```
    > [!NOTE]
    > 上記のスクリプトのパスワードは、必ず複雑なパスワードに置換してください。

1. 新しいロールを一覧表示するには、**pg_catalog.pg_roles** で上記の SELECT クエリをもう一度実行します。 一覧に **dbuser** ロールが表示されます。
1. 新しいロールで **zoodb** データベースの **animal** テーブルのデータに対してクエリを実行して変更できるようにするには、次のコードを実行します。

    ```SQL
    GRANT SELECT, INSERT, UPDATE, DELETE ON animal TO dbuser;
    ```

## 新しいロールをテストする

1. Azure Data Studio の **[接続]** の一覧で、新しい接続ボタンを選択します。
1. **[接続の種類]** の一覧で、**[PostgreSQL]** を選択します。
1. **[サーバー名]** ボックスに、対象の Azure Database for PostgreSQL リソースの完全修飾サーバー名を入力します。 これは Azure portal からコピーできます。
1. **[認証の種類]** の一覧で、**[パスワード]** を選択します。
1. **[ユーザー名]** テキストボックスに「**dbuser**」と入力し、**[パスワード]** テキストボックスにアカウントの作成時に使用した複雑なパスワードを入力します。
1. **[パスワードを記憶する]** チェックボックスを選択し、**[接続]** を選択します。
1. **[新しいクエリ]** を選択し、次のコードを実行します。

    ```SQL
    SELECT * FROM animal;
    ```

1. UPDATE 特権があるかどうかをテストするには、次のコードを実行します。

    ```SQL
    UPDATE animal SET name = 'Linda Lioness' WHERE ani_id = 7;
    SELECT * FROM animal;
    ```

1. DROP 特権があるかどうかをテストするには、次のコードを実行します。 エラーが発生した場合は、エラー コードを確認します。

    ```SQL
    DROP TABLE animal;
    ```

1. GRANT 特権があるかどうかをテストするには、次のコードを実行します。

    ```SQL
    GRANT ALL PRIVILEGES ON animal TO dbuser;
    ```

これらのテストは、新しいユーザーがデータ操作言語 (DML) コマンドを実行してデータのクエリと変更を行うことはできるが、データ定義言語 (DDL) コマンドを使用してスキーマを変更することはできないことを示しています。 また、新しいユーザーは、アクセス許可を回避するために新しい特権を付与することはできません。

## クリーンアップ

この PostgreSQL サーバーは今後使用しないので、作成したリソース グループを削除してサーバーを削除します。
