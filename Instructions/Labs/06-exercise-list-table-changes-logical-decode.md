---
lab:
  title: 論理デコードを使用してテーブルの変更を一覧表示する
  module: Understand write-ahead logging
---

# 論理デコードを使用してテーブルの変更を一覧表示する

この演習では、PostgreSQL にネイティブな論理レプリケーションを構成します。 パブリッシャーとサブスクライバーとして機能する 2 つのサーバーを作成します。 zoodb 内のデータは、それらの間でレプリケートされます。

## 開始する前に

この演習を完了するには、自分の Azure サブスクリプションが必要です。 Azure サブスクリプションをお持ちでない場合は、[Azure 無料試用版](https://azure.microsoft.com/free)を作成できます。

## リソース グループの作成

1. Azure portal にサインインします。 使用するユーザー アカウントは、Azure サブスクリプションの所有者または共同作成者である必要があります。
1. **[リソース グループ]** を選択し、**[+ 作成]** を選択します。
1. サブスクリプションを選択します。
1. [リソース グループ] に「**rg-PostgreSQL_Replication**」と入力します。
1. ご自身の場所に近いリージョンを選択します。
1. **[Review + create](レビュー + 作成)** を選択します。
1. **［作成］** を選択します

## パブリッシャー サーバーを作成する

1. [Azure サービス] で、**[+ リソースの作成]** を選択します。 **[カテゴリ]** で、**[データベース]** を選択します。 **[Azure Database for PostgreSQL]** で、**[作成]** を選択します。
1. フレキシブル サーバーの **[基本]** タブで、各フィールドに次のように入力します。
    1. [サブスクリプション] - お使いのサブスクリプション。
    1. [リソース グループ] - **rg-PostgreSQL_Replication** を選択します。
    1. [サーバー名] - **psql-postgresql-pub9999** (サーバー名はグローバルに一意である必要があるため、9999 を 4 つのランダムな数字に置換してください)。
    1. [リージョン] - リソース グループと同じリージョンを選択します。
    1. [PostgreSQL バージョン] - [16] を選択します。
    1. [ワークロードの種類] - **[開発]**。
    1. [コンピューティングとストレージ] - **[バースト可能]**。 **[サーバーの構成]** を選択し、構成オプションを確認します。 何も変更せずに、セクションを閉じます。
    1. [可用性ゾーン] - 1。 可用性ゾーンがサポートされていない場合は、[優先設定なし] のままにします。
    1. [高可用性] - 無効。
    1. [認証方法] - PostgreSQL の認証のみ。
    1. **[管理者ユーザー名]** に「**`demo`**」と入力します。
    1. **[パスワード]** に適度に複雑なパスワードを入力します。
    1. **[次: ネットワーク >]** を選択します。
1. フレキシブル サーバーの **[ネットワーク]** タブで、各フィールドに次のように入力します。
    1. [接続方法]: (o) パブリック アクセス (許可された IP アドレス)。
    1. **[Azure 内の任意の Azure サービスにこのサーバーへのパブリック アクセスを許可する]** - オン。 パブリッシャー データベースとサブスクライバー データベースが相互に通信できるように、これをオンにする必要があります。
    1. [ファイアウォール規則] で、**[+ 現在のクライアント IP アドレスを追加する]** を選択します。 これにより、現在の IP アドレスがファイアウォール規則として追加されます。 必要に応じて、このファイアウォール規則に意味のある名前を付けることができます。
1. **[Review + create](レビュー + 作成)** を選択します。 **[作成]** を選択します。
1. Azure Database for PostgreSQL の作成には数分かかる場合があるため、このデプロイが進行中になったらすぐに次の手順を開始します。 続行するには、必ず新しいブラウザー画面またはタブを開きます。

## サブスクライバー サーバーを作成する

1. [Azure サービス] で、**[+ リソースの作成]** を選択します。 **[カテゴリ]** で、**[データベース]** を選択します。 **[Azure Database for PostgreSQL]** で、**[作成]** を選択します。
1. フレキシブル サーバーの **[基本]** タブで、各フィールドに次のように入力します。
    1. [サブスクリプション] - お使いのサブスクリプション。
    1. [リソース グループ] - **rg-PostgreSQL_Replication** を選択します。
    1. [サーバー名] - **psql-postgresql-sub9999** (サーバー名はグローバルに一意である必要があるため、9999 を 4 つのランダムな数字に置換してください)。
    1. [リージョン] - リソース グループと同じリージョンを選択します。
    1. [PostgreSQL バージョン] - [16] を選択します。
    1. [ワークロードの種類] - **[開発]**。
    1. [コンピューティングとストレージ] - **[バースト可能]**。 **[サーバーの構成]** を選択し、構成オプションを確認します。 何も変更せずに、セクションを閉じます。
    1. [可用性ゾーン] - 2。 可用性ゾーンがサポートされていない場合は、[優先設定なし] のままにします。
    1. [高可用性] - 無効。
    1. [認証方法] - PostgreSQL の認証のみ。
    1. **[管理者ユーザー名]** に「**`demo`**」と入力します。
    1. **[パスワード]** に適度に複雑なパスワードを入力します。
    1. **[次: ネットワーク >]** を選択します。
1. フレキシブル サーバーの **[ネットワーク]** タブで、各フィールドに次のように入力します。
    1. [接続方法]: (o) パブリック アクセス (許可された IP アドレス)
    1. **[Azure 内の任意の Azure サービスにこのサーバーへのパブリック アクセスを許可する]** - オン。 パブリッシャー データベースとサブスクライバー データベースが相互に通信できるように、これをオンにする必要があります。
    1. [ファイアウォール規則] で、**[+ 現在のクライアント IP アドレスを追加する]** を選択します。 これにより、現在の IP アドレスがファイアウォール規則として追加されます。 必要に応じて、このファイアウォール規則に意味のある名前を付けることができます。
1. **[Review + create](レビュー + 作成)** を選択します。 **[作成]** を選択します。
1. 両方の Azure Database for PostgreSQL サーバーがデプロイされるまで待ちます。

## レプリケーションを設定する

パブリッシャー サーバーとサブスクライバー サーバーの*両方*に対して、次の手順を実行します。

1. Azure portal でサーバーに移動し、[設定] で **[サーバー パラメーター]** を選択します。
1. 検索バーを使って各パラメーターを検索し、次の変更を行います。
    1. `wal_level` = LOGICAL
    1. `max_worker_processes` = 24
1. **[保存]** を選択します。 その後、**[保存して再起動]** を選択します。
1. 両方のサーバーが再起動するまで待ちます。

    > Note
    >
    > サーバーが再デプロイされた後、サーバーが再起動したことを確認するためにブラウザー画面を更新する必要がある場合があります。

## 続行する前に、次の点に注意してください。

次のことを確認してください。

1. 両方の Azure Database for PostgreSQL フレキシブル サーバーをインストールして起動しました。
1. [PostgreSQL ラボ](https://github.com/MicrosoftLearning/mslearn-postgresql.git) からラボ スクリプトを既に複製してあります。 まだ行っていない場合は、ローカルにリポジトリを複製してください。
    1. コマンド ライン/ターミナルを開きます。
    1. 次のコマンドを実行します。
       ```bash
       md .\DP3021Lab
       git clone https://github.com/MicrosoftLearning/mslearn-postgresql.git .\DP3021Lab
       ```
       > 注
       > 
       > **Git** がインストールされていない場合は、[***Git*** アプリをダウンロードしてインストールし](https://git-scm.com/download)、前のコマンドをもう一度実行してみてください。
1. Azure Data Studio をインストールしました。 インストールしていない場合は、[***Azure Data Studio*** をダウンロードしてインストールしてください](https://go.microsoft.com/fwlink/?linkid=2282284)。
1. Azure Data Studio に **PostgreSQL** 拡張機能をインストールします。

## パブリッシャーを設定する

1. Azure Data Studio を開き、パブリッシャー サーバーに接続します。 ([概要] セクションからサーバー名をコピーしてください。)
1. **[ファイル]**、**[ファイルを開く]** の順に選択し、スクリプトを保存したフォルダーに移動します。
1. スクリプト **../Allfiles/Labs/06/Lab6_Replication.sql** を開き、サーバーに接続します。
1. **[Grant the admin user replication permission] (管理者ユーザーにレプリケーション権限を付与する)** セクションを強調表示して実行します。
1. **[Create zoodb database] (zoodb データベースの作成)** セクションを強調表示して実行します。
1. ツール バーのドロップダウン リストを使って、現在のデータベースとして zoodb を選択します。 **SELECT** ステートメントを実行して、zoodb が現在のデータベースであることを確認します。
1. zoodb で **[テーブルの作成]** セクションと**外部キー制約**を強調表示して実行します。
1. **[Populate the tables in zoodb] (zoodb のテーブルを設定する)** セクションを強調表示して実行します。
1. **[Create a publication] (パブリケーションの作成)** セクションを強調表示して実行します。 SELECT ステートメントを実行すると、レプリケーションがまだアクティブではないため、何も一覧表示されません。

## サブスクライバーをセットアップする

1. Azure Data Studio の 2 番目のインスタンスを開き、サブスクライバー サーバーに接続します。
1. **[ファイル]**、**[ファイルを開く]** の順に選択し、スクリプトを保存したフォルダーに移動します。
1. スクリプト **../Allfiles/Labs/06/Lab6_Replication.sql** を開き、サブスクライバー サーバーに接続します。 ([概要] セクションからサーバー名をコピーしてください。)
1. **[Grant the admin user replication permission] (管理者ユーザーにレプリケーション権限を付与する)** セクションを強調表示して実行します。
1. **[Create zoodb database] (zoodb データベースの作成)** セクションを強調表示して実行します。
1. ツール バーのドロップダウン リストを使って、現在のデータベースとして zoodb を選択します。 **SELECT** ステートメントを実行して、zoodb が現在のデータベースであることを確認します。
1. zoodb で **[テーブルの作成]** セクションと**外部キー制約**を強調表示して実行します。
1. **[サブスクリプションを作成する]** セクションまで下にスクロールします。
    1. **CREATE SUBSCRIPTION** ステートメントを編集して、正しいパブリッシャー サーバー名とパブリッシャーの強力なパスワードを含めます。 ステートメントを強調表示して実行します。
    1. **SELECT** ステートメントを強調表示して実行します。 作成したサブスクリプション "sub" が表示されます。
1. **[Display the tables] (テーブルの表示)** セクションで、各 **SELECT** ステートメントを強調表示して実行します。 テーブルは、パブリッシャーからのレプリケーションによって設定されています。

## パブリッシャー データベースに変更を加える

- Azure Data Studio の最初のインスタンス (*パブリッシャー インスタンス*) で、**[追加の animal の挿入]** の下にある **INSERT** ステートメントを強調表示して実行します。 *この INSERT ステートメントはサブスクライバーで実行**しない**でください*。

## サブスクライバー データベースで変更を表示する

- Azure Data Studio の 2 番目のインスタンス (サブスクライバー) で、**[Display the animal tables] (animal テーブルの表示)** で **SELECT** ステートメントを強調表示して実行します。

これで、2 つの Azure Database for PostgreSQL フレキシブル サーバーを作成し、1 台をパブリッシャーとして、もう 1 台をサブスクライバーとして構成できました。 パブリッシャー データベースでは、zoo データベースを作成して設定しました。 サブスクライバー データベースでは、空のデータベースを作成した後、ストリーミング レプリケーションによって設定しました。

## クリーンアップ

1. 演習が終了したら、両方のサーバーを含むリソース グループを削除します。 サーバーを停止または削除しない限り、サーバーに対して課金されます。
1. 必要に応じて、.\DP3021Lab フォルダーを削除します。
