---
lab:
  title: 論理デコードを使用してテーブルの変更を一覧表示する
  module: Understand write-ahead logging
---

# 論理デコードを使用してテーブルの変更を一覧表示する

この演習では、PostgreSQL にネイティブな論理レプリケーションを構成します。 パブリッシャーとサブスクライバーとして機能する 2 つのサーバーを作成します。 zoodb 内のデータは、それらの間でレプリケートされます。

## 開始する前に

この演習を完了するには、自分の Azure サブスクリプションが必要です。 Azure サブスクリプションをお持ちでない場合は、[Azure 無料試用版](https://azure.microsoft.com/free)を作成できます。

コンピューターに以下がインストールされている必要があります。

- Visual Studio Code。
- Postgres Visual Studio Code Extension by Microsoft。
- Azure CLI。
- Git.

## 演習環境を作成する

この演習以降の演習では、Bicep スクリプトを使用して、Azure Database for PostgreSQL - フレキシブル サーバーとその他のリソースを Azure サブスクリプションにデプロイします。 Bicep スクリプトは、前にクローンした GitHub リポジトリの`/Allfiles/Labs/Shared`フォルダーにあります。

### Visual Studio Code と PostgreSQL 拡張機能をダウンロードしてインストールします。

Visual Studio Code がインストールされていない場合:

1. ブラウザーで、[Visual Studio Code のダウンロード](https://code.visualstudio.com/download)に移動し、オペレーティング システムに適したバージョンを選択します。

1. 使用しているオペレーティング システムのインストール手順に従ってください。

1. Visual Studio Code を開きます。

1. 左側のメニューで **[拡張機能]** を選んで、[拡張機能] パネルを表示します。

1. 検索バーに「**PostgreSQL**」と入力します。 Visual Studio Code 用 PostgreSQL 拡張機能のアイコンが表示されます。 Microsoft による製品が選択されていることを確認します。

1. **[インストール]** を選択します。 拡張機能がインストールされます。

### Azure CLI と Git のダウンロードとインストール

Azure CLI または Git がインストールされていない場合:

1. ブラウザーで、[Azure CLI のインストール](https://learn.microsoft.com/cli/azure/install-azure-cli)の、オペレーティング システムのインストール手順に従ってください。

1. ブラウザーで、 [Git のダウンロードとインストール](https://git-scm.com/downloads)に移動し、オペレーティング システムの指示に従います。

### 演習用ファイルをダウンロードする

演習ファイルを含む GitHub リポジトリを既にクローンしている場合は、*演習ファイルのダウンロードをスキップします*。

演習ファイルをダウンロードするには、演習ファイルを含む GitHub リポジトリをローカル コンピューターにクローンします。 リポジトリには、この演習を完了するために必要なすべてのスクリプトとリソースが含まれています。

1. まだ開いていない場合は、Visual Studio Code を開きます。

1. **[すべてのコマンドを表示]** (Ctrl + Shift + P) を選択してコマンド パレットを開きます。

1. コマンド パレットで、**Git: Clone** を検索して選択します。

1. コマンド パレットで、次のように入力して、演習リソースを含む GitHub リポジトリをクローンし、 **Enter** キーを押します。

    ```bash
    https://github.com/MicrosoftLearning/mslearn-postgresql.git
    ```

1. 画面の指示に従って、プロジェクトをクローンするリポジトリの場所を選択します。 リポジトリは、選択した場所の `mslearn-postgresql` という名前のフォルダーにクローンされます。

1. 複製したリポジトリを開くかどうかを尋ねられたら **[開く]** を選択します。 Visual Studio Code でリポジトリを開きます。

## リソース グループを作成する

このセクションでは、Azure Database for PostgreSQL サーバーを含むリソース グループを作成します。 リソース グループは、Azure ソリューションの関連リソースを格納する論理コンテナーです。

1. Azure portal にサインインします。 使用するユーザー アカウントは、Azure サブスクリプションの所有者または共同作成者である必要があります。

1. **[リソース グループ]** を選択し、**[+ 作成]** を選択します。

1. サブスクリプションを選択します。

1. [リソース グループ] に「**rg-PostgreSQL_Replication**」と入力します。

1. ご自身の場所に近いリージョンを選択します。

1. **[Review + create](レビュー + 作成)** を選択します。

1. **［作成］** を選択します

## パブリッシャー サーバーを作成する

このセクションでは、パブリッシャー サーバーを作成します。 パブリッシャー サーバーは、サブスクライバー サーバーにレプリケートされるデータのソースです。

1. [Azure サービス] で、**[+ リソースの作成]** を選択します。 **[カテゴリ]** で、**[データベース]** を選択します。 **[Azure Database for PostgreSQL]** で、**[作成]** を選択します。

1. フレキシブル サーバーの **[基本]** タブで、各フィールドに次のように入力します。
    - **[サブスクリプション]** - お使いのサブスクリプション。
    - **[リソース グループ]** - **rg-PostgreSQL_Replication** を選択します。
    - **[サーバー名]** - *psql-postgresql-pub9999* (サーバー名はグローバルに一意である必要があるため、9999 を 4 つのランダムな数字に置換してください)。
    - **[リージョン]** - リソース グループと同じリージョンを選択します。
    - **[PostgreSQL バージョン]** - [16] を選択します。
    - **[ワークロードの種類]** - *[開発]*。
    - **[コンピューティング + ストレージ]** - *[バースト可能]*。 **[サーバーの構成]** を選択し、構成オプションを確認します。 何も変更せずに、セクションを閉じます。
    - **[可用性ゾーン]** - 1。 可用性ゾーンがサポートされていない場合は、[優先設定なし] のままにします。
    - **[高可用性]** - [無効]。
    - **[認証方法]** - [PostgreSQL 認証のみ]。
    - **[管理者ユーザー名]** に **`pgAdmin`** と入力します。
    - **[パスワード]** に適度に複雑なパスワードを入力します。

1. **[次: ネットワーク >]** を選択します。

1. フレキシブル サーバーの **[ネットワーク]** タブで、各フィールドに次のように入力します。
    - **[接続方法]**: (o) パブリック アクセス (許可された IP アドレス)。
    - **[Azure 内の任意の Azure サービスにこのサーバーへのパブリック アクセスを許可する]** - オンにします。 パブリッシャー データベースとサブスクライバー データベースが相互に通信できるように、このオプションをオンにする必要があります。
    - **[ファイアウォール規則]**: **[+ 現在のクライアント IP アドレスを追加する]** を選択します。 これにより、現在の IP アドレスがファイアウォール規則として追加されます。 必要に応じて、このファイアウォール規則に意味のある名前を付けることができます。

1. **[確認と作成]** を選択します。 **[作成]** を選択します。

1. Azure Database for PostgreSQL の作成には数分かかる場合があるため、このデプロイが進行中になったらすぐに次の手順を開始します。 続行するには、必ず新しいブラウザー画面またはタブを開きます。

## サブスクライバー サーバーを作成する

1. [Azure サービス] で、**[+ リソースの作成]** を選択します。 **[カテゴリ]** で、**[データベース]** を選択します。 **[Azure Database for PostgreSQL]** で、**[作成]** を選択します。

1. フレキシブル サーバーの **[基本]** タブで、各フィールドに次のように入力します。
    - **[サブスクリプション]** - お使いのサブスクリプション。
    - **[リソース グループ]** - **rg-PostgreSQL_Replication** を選択します。
    - **[サーバー名]** - *psql-postgresql-sub9999* (サーバー名はグローバルに一意である必要があるため、9999 を 4 つのランダムな数字に置換してください)。
    - **[リージョン]** - リソース グループと同じリージョンを選択します。
    - **[PostgreSQL バージョン]** - [16] を選択します。
    - **[ワークロードの種類]** - *[開発]*。
    - **[コンピューティング + ストレージ]** - *[バースト可能]*。 **[サーバーの構成]** を選択し、構成オプションを確認します。 何も変更せずに、セクションを閉じます。
    - **可用性ゾーン** - 2。 可用性ゾーンがサポートされていない場合は、[優先設定なし] のままにします。
    - **[高可用性]** - [無効]。
    - **[認証方法]** - [PostgreSQL 認証のみ]。
    - **[管理者ユーザー名]** に **`pgAdmin`** と入力します。
    - **[パスワード]** に適度に複雑なパスワードを入力します。

1. **[次: ネットワーク >]** を選択します。

1. フレキシブル サーバーの **[ネットワーク]** タブで、各フィールドに次のように入力します。
    - **[接続方法]**: (o) パブリック アクセス (許可された IP アドレス)。
    - **[Azure 内の任意の Azure サービスにこのサーバーへのパブリック アクセスを許可する]** - オンにします。 パブリッシャー データベースとサブスクライバー データベースが相互に通信できるように、このオプションをオンにする必要があります。
    - **[ファイアウォール規則]**: **[+ 現在のクライアント IP アドレスを追加する]** を選択します。 これにより、現在の IP アドレスがファイアウォール規則として追加されます。 必要に応じて、このファイアウォール規則に意味のある名前を付けることができます。

1. **[確認と作成]** を選択します。 **[作成]** を選択します。

1. 両方の Azure Database for PostgreSQL サーバーがデプロイされるまで待ちます。

## レプリケーションを設定する

パブリッシャー サーバーとサブスクライバー サーバーの*両方*に対して、次の手順を実行します。

1. Azure portal でサーバーに移動し、[設定] で **[サーバー パラメーター]** を選択します。

1. 検索バーを使って各パラメーターを検索し、次の変更を行います。
    - `wal_level` = LOGICAL
    - `max_worker_processes` = 24

1. **[保存]** を選択します。 その後、**[保存して再起動]** を選択します。

1. 両方のサーバーが再起動するまで待ちます。

    > &#128221; サーバーが再デプロイされた後、サーバーが再起動したことを確認するには、場合によってブラウザー ウィンドウを最新の情報に更新する必要があります。

## パブリッシャーを設定する

このセクションでは、パブリッシャー サーバーを設定します。 パブリッシャー サーバーは、サブスクライバー サーバーにレプリケートされるデータのソースです。

1. Visual Studio Code の最初のインスタンスを開いて、パブリッシャー サーバーに接続します。

1. GitHub リポジトリを複製したフォルダーを開きます。

1. 左側のメニューで **PostgreSQL** アイコンを選択します。

    > &#128221; PostgreSQL アイコンが表示されない場合は、**Extensions** アイコンを選択し、**PostgreSQL** を検索します。 Microsoft の **PostgreSQL** 拡張機能を選択し、**[インストール]** を選択します。

1. PostgreSQL *パブリッシャー* サーバーへの接続を既に作成してある場合は、次の手順に進みます。 新しい接続の作成:

    1. **PostgreSQL** 拡張機能で、**[+ 接続の追加]** を選択して、新しい接続を追加します。

    1. **[新しい接続]** ダイアログ ボックスで、次の情報を入力します。

        - **サーバー名**: `<your-publisher-server-name>`.postgres.database.azure.com
        - **[認証の種類]**: パスワード
        - **ユーザー名**: pgAdmin
        - **パスワード**: 以前に生成したランダムなパスワード。
        - **[パスワードの保存]** チェック ボックスをオンにします。
        - **接続名**: `<your-publisher-server-name>`

    1. 接続をテストするには、**[テスト接続]** を選択します。 接続が成功した場合は、**[保存して接続]** を選択して接続を保存し、それ以外の場合は接続情報を確認して、もう一度やり直します。

1. まだ接続されていない場合は、PostgreSQL サーバーの **[接続]** を選択します。 Azure Database for PostgreSQL サーバーに接続されます。

1. サーバー ノードとそのデータベースを展開します。 既存のデータベースが一覧表示されます。

1. Visual Studio Code 内で、**[ファイル]**、**[ファイルを開く]** の順に選択し、スクリプトを保存したフォルダーに移動します。 **../Allfiles/Labs/06/Lab6_Replication.sql** を選択し、**[開く]** を選択します。

1. Visual Studio Code の右下で、接続が緑色になっていることを確認します。 そうでない場合は、**PGSQL Disconnected** と表示されます。 **[PGSQL Disconnected]** テキストを選択し、コマンド パレットの一覧から [PostgreSQL サーバー接続] を選択します。 パスワードを要求された場合は、前に生成したパスワードを入力します。

1. それでは、*パブリッシャー*を設定します。

    1. **[Grant the admin user replication permission] (管理者ユーザーにレプリケーション権限を付与する)** セクションを強調表示して実行します。

    1. **[Create zoodb database] (zoodb データベースの作成)** セクションを強調表示して実行します。

    1. **SELECT current_database()** ステートメントだけを強調表示して実行すると、データベースが現在 `postgres` に設定されていることがわかります。 それを `zoodb` に変更する必要があります。

    1. メニューバーの *実行* アイコンのある省略記号を選択し、**[PostgreSQL データベースの変更]** を選択します。 データベースの一覧から `zoodb` を選択します。

        > &#128221; クエリ ペインでデータベースを変更することもできます。 サーバー名とデータベース名は、クエリ タブ自体の下に書き留めることができます。 データベース名を選択すると、データベースの一覧が表示されます。 一覧から `zoodb` データベースを選択します。

    1. zoodb で **[テーブルの作成]** セクションと**外部キー制約**を強調表示して実行します。

    1. **[Populate the tables in zoodb] (zoodb のテーブルを設定する)** セクションを強調表示して実行します。

    1. **[Create a publication] (パブリケーションの作成)** セクションを強調表示して実行します。 SELECT ステートメントを実行すると、レプリケーションがまだアクティブではないため、何も一覧表示されません。

    1. **CREATE SUBSCRIPTION** セクションを実行しないでください。 このスクリプトは、サブスクライバー サーバーで実行されます。

    1. Visual Studio Code インスタンスは最小化しておき、閉じないでください。 サブスクライバー サーバーを設定した後、この Visual Studio Code インスタンスに戻ります。

これで、パブリッシャー サーバーと zoodb データベースが作成されました。 データベースには、サブスクライバー サーバーにレプリケートされたテーブルとデータが含まれています。

## サブスクライバーをセットアップする

このセクションでは、サブスクライバー サーバーを設定します。 サブスクライバー サーバーは、パブリッシャー サーバーからレプリケートされるデータの目的地です。 サブスクライバー サーバー上に新しいデータベースを作成します。このデータベースに、パブリッシャー サーバーからのデータが入力されます。

1. Visual Studio Code の *2 番目のインスタンス*を開き、サブスクライバー サーバーに接続します。

1. GitHub リポジトリを複製したフォルダーを開きます。

1. 左側のメニューで **PostgreSQL** アイコンを選択します。

    > &#128221; PostgreSQL アイコンが表示されない場合は、**Extensions** アイコンを選択し、**PostgreSQL** を検索します。 Microsoft の **PostgreSQL** 拡張機能を選択し、**[インストール]** を選択します。

1. PostgreSQL の*サブスクライバー* サーバーへの接続を既に作成してある場合は、次の手順に進みます。 新しい接続の作成:

    1. **PostgreSQL** 拡張機能で、**[+ 接続の追加]** を選択して、新しい接続を追加します。

    1. **[新しい接続]** ダイアログ ボックスで、次の情報を入力します。

        - **サーバー名**: `<your-subscriber-server-name>`.postgres.database.azure.com
        - **[認証の種類]**: パスワード
        - **ユーザー名**: pgAdmin
        - **パスワード**: 以前に生成したランダムなパスワード。
        - **[パスワードの保存]** チェック ボックスをオンにします。
        - **接続名**: `<your-subscriber-server-name>`

    1. 接続をテストするには、**[テスト接続]** を選択します。 接続が成功した場合は、**[保存して接続]** を選択して接続を保存し、それ以外の場合は接続情報を確認して、もう一度やり直します。

1. まだ接続されていない場合は、PostgreSQL サーバーの **[接続]** を選択します。 Azure Database for PostgreSQL サーバーに接続されます。

1. サーバー ノードとそのデータベースを展開します。 既存のデータベースが一覧表示されます。

1. Visual Studio Code 内で、**[ファイル]**、**[ファイルを開く]** の順に選択し、スクリプトを保存したフォルダーに移動します。 **../Allfiles/Labs/06/Lab6_Replication.sql** を選択し、**[開く]** を選択します。

1. Visual Studio Code の右下で、接続が緑色になっていることを確認します。 そうでない場合は、**PGSQL Disconnected** と表示されます。 **[PGSQL Disconnected]** テキストを選択し、コマンド パレットの一覧から [PostgreSQL サーバー接続] を選択します。 パスワードを要求された場合は、前に生成したパスワードを入力します。

1. それでは、*サブスクライバー*を設定します。

    1. **[Grant the admin user replication permission] (管理者ユーザーにレプリケーション権限を付与する)** セクションを強調表示して実行します。

    1. **[Create zoodb database] (zoodb データベースの作成)** セクションを強調表示して実行します。

    1. **SELECT current_database()** ステートメントだけを強調表示して実行すると、データベースが現在 `postgres` に設定されていることがわかります。 それを `zoodb` に変更する必要があります。

    1. メニューバーの *実行* アイコンのある省略記号を選択し、**[PostgreSQL データベースの変更]** を選択します。 データベースの一覧から `zoodb` を選択します。

        > &#128221; クエリ ペインでデータベースを変更することもできます。 サーバー名とデータベース名は、クエリ タブ自体の下に書き留めることができます。 データベース名を選択すると、データベースの一覧が表示されます。 一覧から `zoodb` データベースを選択します。

    1. `zoodb` で **[テーブルの作成]** セクションと**外部キー制約**を強調表示して実行します。

    1. **[パブリケーションの作成]** セクションを実行しないでください。このステートメントはパブリッシャー サーバーで既に実行されています。

    1. **[サブスクリプションを作成する]** セクションまで下にスクロールします。

        1. **CREATE SUBSCRIPTION** ステートメントを編集して、正しいパブリッシャー サーバー名とパブリッシャーの強力なパスワードを含めます。 ステートメントを強調表示して実行します。

        1. **SELECT** ステートメントを強調表示して実行します。 先ほど作成したサブスクリプション "sub" が表示されます。

    1. **[テーブルの表示]** セクションで、各 **SELECT** ステートメントを強調表示して実行します。 パブリッシャー サーバーにより、これらのテーブルには、レプリケーションを通じて値が入力されています。

これで、サブスクライバー サーバーと zoodb データベースが作成されました。 このデータベースには、パブリッシャー サーバーからレプリケートされたテーブルとデータが含まれています。

## パブリッシャー データベースに変更を加える

- Visual Studio Code の最初のインスタンス (*パブリッシャー インスタンス*) で、**[追加の animal の挿入]** の下にある **INSERT** ステートメントを強調表示して実行します。 *この INSERT ステートメントはサブスクライバーで実行**しない**でください*。

## サブスクライバー データベースで変更を表示する

- Visual Studio Code の 2 番目のインスタンス (サブスクライバー) で、**[animal テーブルの表示]** の下にある **SELECT** ステートメントを強調表示して実行します。

これで、2 つの Azure Database for PostgreSQL フレキシブル サーバーを作成し、1 つをパブリッシャーとして、もう 1 つをサブスクライバーとして構成しました。 パブリッシャー データベースでは、zoo データベースを作成してデータを入力しました。 サブスクライバー データベースでは、空のデータベースを作成した後、ストリーミング レプリケーションによって設定しました。

## クリーンアップ

1. 他の演習でこれらの PostgreSQL サーバーが不要な場合は、不要な Azure コストが発生しないように、この演習で作成したリソース グループを削除します。

1. PostgreSQL サーバーを継続して稼働させる場合は、そのまま稼動させておくことができます。 そうでない場合は、不要なコストが発生しないように、Bash ターミナルでサーバーを停止できます。 サーバーを停止するには、サーバーごとに次のコマンドを実行します。

    ```bash

    ```azurecli
    az postgres flexible-server stop --name <your-server-name> --resource-group $RG_NAME
    ```

    `<your-server-name>` を、お使いの PostgreSQL サーバーの名前に置き換えます。

    > &#128221; Azure portal からサーバーを停止することもできます。 Azure portal で **[Resource グループ]** に移動し、前に作成したリソース グループを選択します。 PostgreSQL サーバーを選択し、メニューから **[停止]** を選択します。 パブリッシャー サーバーとサブスクライバー サーバーの両方に対して、この手順を実行します。

1. 必要に応じて、先ほどクローンした Git リポジトリを削除します。

これで PostgreSQL サーバーが正常に作成され、論理レプリケーション用に構成されました。 パブリッシャー サーバーとサブスクライバー サーバーを作成し、それらの間のレプリケーションを設定しました。 また、パブリッシャー データベースに変更を加え、変更内容をサブスクライバー データベース上で確認しました。 PostgreSQL で論理レプリケーションを設定する方法の説明は以上です。
